# name: test/sql/storage/optimistic_write/optimistic_write_no_block_reuse.test_slow
# description: Test that the WAL keeps references to optimistically written blocks alive
# group: [optimistic_write]

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
PRAGMA wal_autocheckpoint = '1TB';

statement ok
SET debug_skip_checkpoint_on_commit=true

statement ok
SET write_buffer_row_group_count = 1;

statement ok
ATTACH '__TEST_DIR__/concurrent_drop_blocks.db' AS db;

statement ok con1
CREATE TABLE db.t (a BIGINT PRIMARY KEY, b VARCHAR, c VARCHAR, d VARCHAR);

statement ok con1
INSERT INTO db.t SELECT i, 'row_' || i || repeat('x', 20),
	'data_' || i || repeat('y', 30), 'col_' || i || repeat('z', 25)
	FROM generate_series(0, 249999) t(i);

statement ok con2
DROP TABLE db.t;

statement ok con2
CREATE TABLE db.t2 (a DOUBLE, b DOUBLE, c DOUBLE, d DOUBLE);

statement ok con2
INSERT INTO db.t2 SELECT i * 3.14159, i * 2.71828, i * 1.41421, i * 1.73205
	FROM generate_series(0, 999999) t(i);

statement ok
DETACH db;

statement ok
ATTACH '__TEST_DIR__/concurrent_drop_blocks.db' AS db;

query I
SELECT COUNT(*) FROM db.t2;
----
1000000
