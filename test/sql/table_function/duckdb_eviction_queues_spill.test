# name: test/sql/table_function/duckdb_eviction_queues_spill.test
# description: Test eviction queue behavior during external aggregation (spill to disk)
# group: [table_function]

load __TEST_DIR__/eviction_queues_spill.db

statement ok
CREATE MACRO fudge() AS (100);

statement ok
CREATE MACRO eviction_invariants_ok() AS (
  SELECT COUNT(*) = 0 FROM duckdb_eviction_queues()
  WHERE dead_nodes < 0
    OR dead_nodes > approximate_size + fudge()
    OR dead_nodes > total_insertions
    OR total_insertions < approximate_size - fudge()
);

statement ok
CREATE MACRO queue_has_alive_blocks(idx) AS (
  SELECT (approximate_size - dead_nodes > 0)::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

statement ok
CREATE MACRO queue_mostly_dead(idx) AS (
  SELECT (dead_nodes > approximate_size / 2)::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

statement ok
CREATE MACRO any_queue_mostly_dead() AS (
  SELECT (COUNT(*) > 0)::INT
  FROM duckdb_eviction_queues()
  WHERE dead_nodes > approximate_size / 2
);

statement ok
CREATE MACRO queue_no_eviction(idx) AS (
  SELECT (abs(approximate_size - total_insertions) <= fudge())::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

statement ok
CREATE TABLE t AS SELECT range AS i, range::VARCHAR AS s FROM range(200000);

statement ok
CHECKPOINT;

query I
SELECT count(*) FROM t;
----
200000

query I
SELECT queue_has_alive_blocks(1);
----
1

query I
SELECT queue_no_eviction(1);
----
1

query I
SELECT eviction_invariants_ok();
----
1

statement ok
SET memory_limit='8MB';

query I
SELECT count(DISTINCT i) FROM t;
----
200000

query I
SELECT eviction_invariants_ok();
----
1

query I
SELECT any_queue_mostly_dead();
----
1

statement ok
SET memory_limit='2GB';

query I
SELECT count(*) FROM t;
----
200000

query I
SELECT queue_has_alive_blocks(1);
----
1

query I
SELECT eviction_invariants_ok();
----
1
